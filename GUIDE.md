# Fusion Chain CLI Guide

This document leads through the features of Fusion Chain 
with the CLI interface and demonstrates the experience 
of interacting with a mocked MPC.

You can also deploy a web application locally. Please follow the steps indicated in [Web Frontend](./SETUP.md#web-frontend).

## Contents

* [Prerequisites](#prerequisites)
* [Start](#start)
    * [Basic Walkthrough](#basic-walkthrough)
    * [Broadcast](#broadcast)
        * [Pregenerated](#pregenerated)
        * [More Transactions](#more-tx)
    * [Manage Workspaces](#manage-workspaces)
    * [QAssets](#qassets)

## Prerequisites

In case you want to run the blockchain on your own machine, please follow the [Setup](./SETUP.md) document. 

It's suggested to create an alias like this:

```bash
alias fchain="fusiond --node tcp://localhost:26657 --home ~/.fusiond/ --from shulgin --gas-prices 1000000000nQRDO"
```

## Start

Full list of CLI commands:

- https://www.notion.so/qredo/Fusion-Functional-Requirements-0f822bdc7d6a4aba81f6161935408b35?pvs=4#f1d09276cf55411385c2856a07d4f142
- This does not include default Cosmos SDK commands

### Basic Walkthrough

```bash
# create a new workspace
fchain tx identity new-workspace --yes

# check for newly created workspace
fchain q identity workspaces

# creata a new key of type `ecdsa`` for the workspace with a time to live of 1000 blocks
fchain tx treasury new-key-request qredoworkspace14a2hpadpsy9h5m6us54 qredokeyring1ph63us46lyw56vrzgaq ecdsa 1000 --yes 

# wait for the MPC (keyring_addr = "qredokeyring1ph63us46lyw56vrzgaq") to pick up the request and generate a new key
# you can monitor all the requests with:
fchain q treasury key-requests qredokeyring1ph63us46lyw56vrzgaq all

# and after the request in fulfilled you will find the public key along with addresses for supported wallet types in fusionchain:
fchain q treasury keys qredoworkspace14a2hpadpsy9h5m6us54

# let's use your new key to sign a payload
# payload must be a 32byte hash of arbitrary data to be singed
fchain tx treasury new-signature-request 1 '778f572f33acfab831365d52e563a0ddd2829ddd7060bec69719b7e41f6ef91c' 1000 --yes

# after a while you'll be able to retrieve the signature generated by the keyring
fchain q treasury signature-requests qredokeyring1ph63us46lyw56vrzgaq all

### Broadcast

For the wallet address generated in the previous step, make sure it is funded. For this example, we are using `0xC828Bf9126667972400E1ABE600BAAB877B1e674` as an example. 

For the testnet Qredo runs its own watcher to broadcast the transaction. You can also run your own.

#### Pregenerated

This unsigned transaction only works for the first transaction to be sent from an address. The transaction looks as follows: 

```
nonce: 0
to: 0x993f45666B2A78434711D1a20D2A9733c07A5318
amount: 4000000000000000 WEI
gasLimit: 21000
gasPrice: 20000000000
data: 
```

Now request the transaction to be signed by the Fusion MPCs

```bash
# submit unsigned tx to be signed
fchain tx treasury new-sign-transaction-request 1 ethereum eb808504a817c80082520894993f45666b2a78434711d1a20d2a9733c07a5318870e35fa931a000080808080 1000 --yes

# check the tx signature request has been fulfilled
fchain query treasury sign-transaction-requests ethereum
```

#### More Tx

To create more transactions for that wallet, generate the unsigned tx by yourself:

```bash
# switch to the relayer-eth
cd relayer-eth

# create a unsinged transaction, adjust the nonce
go run ./cmd/buildtx/ -nonce 0 -to 0x993f45666B2A78434711D1a20D2A9733c07A5318 -amount 4000000000000000

# increase the nonce for each new transaction you want to submit
```

### Manage Workspaces

You can add and remove owners or adjust policies inside a workspace. 

```bash
# add a new owner to the workspace
fchain tx identity add-workspace-owner qredoworkspace14a2hpadpsy9h5m6us54 qredo1s3qj9p0ymugy6chyrwy3ft2s5u24fc320vdvv5 1000 --yes

# check the new owner has been added to the workspace
fchain q identity workspaces-by-owner qredo1s3qj9p0ymugy6chyrwy3ft2s5u24fc320vdvv5

# remove owner from the workspace
fchain tx identity remove-workspace-owner qredoworkspace14a2hpadpsy9h5m6us54 qredo1s3qj9p0ymugy6chyrwy3ft2s5u24fc320vdvv5 --yes

# check the new owner has been removed to the workspace
fchain q identity workspaces-by-owner qredo1s3qj9p0ymugy6chyrwy3ft2s5u24fc320vdvv5

# create a new workspace and append it to an existing one
fchain tx identity new-child-workspace qredoworkspace14a2hpadpsy9h5m6us54 1000 --yes

# check the indicated workspace has a new workspace as child_workspace
fchain q identity workspaces
```

### Manage Policies

You can add custom policies to fusionchain and assign it to your workspaces. 

```bash
## create new policy. define participants of this policy with the default and a second user
fchain tx policy new-policy test "(p1 + p2) > 0" -p p1:qredo1d652c9nngq5cneak2whyaqa4g9ehr8psyl0t7j,p2:qredo1s3qj9p0ymugy6chyrwy3ft2s5u24fc320vdvv5 --yes

## check the new policy was created. Investigate the definition and the participants which should be the same as in the previous step
fchain q policy policies

## update the admin and sign policy of the workspace to the new policy (id=1)
fchain tx identity update-workspace qredoworkspace14a2hpadpsy9h5m6us54 1 1 1000 --yes

## check the workspace has admin_policy_id and signature_policy_id = "1"
fchain q identity workspace-by-address qredoworkspace14a2hpadpsy9h5m6us54

## create a new policy to later add it to a workspace
fchain tx policy new-policy test "(p1) > 0" -p p1:qredo1d652c9nngq5cneak2whyaqa4g9ehr8psyl0t7j --yes

## check if the new policy with id="2" was created.
fchain q policy policies

## update the admin policy of the workspace with the new policy (id="2")
fchain tx identity update-workspace qredoworkspace14a2hpadpsy9h5m6us54 2 1 1000 --yes

## check the workspace has admin_policy_id = "2" and signature_policy_id = "1"
fchain q identity workspace-by-address qredoworkspace14a2hpadpsy9h5m6us54
```