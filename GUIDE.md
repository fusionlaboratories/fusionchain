# Fusion Chain Guide

This document leads through the features of Fusion Chain 
with the CLI interface and demonstrates the experience 
of interacting with a mocked MPC.

## Contents

* [Prerequisites](#prerequisites)
* [Start](#start)
    * [Basic Walkthrough](#basic-walkthrough)
    * [Broadcast](#broadcast)
        * [Pregenerated](#pregenerated)
        * [More Transactions](#more-tx)
    * [Manage Workspaces](#manage-workspaces)
    * [QAssets](#qassets)

## Prerequisites

In case you want to run the blockchain on your own machine, please follow the [Setup](./SETUP.md) document. 

It's suggested to create an alias like this:

```bash
alias fchain="fusiond --node tcp://localhost:26657 --home ~/.fusiond/ --from shulgin --gas-prices 1000000000nQRDO"
```

## Start

Full list of CLI commands:

- https://www.notion.so/qredo/Fusion-Functional-Requirements-0f822bdc7d6a4aba81f6161935408b35?pvs=4#f1d09276cf55411385c2856a07d4f142
- This does not include default Cosmos SDK commands

### Basic Walkthrough

```bash
# create a new workspace
fchain tx identity new-workspace --yes

# check for newly created workspace
fchain q identity workspaces

# creata a new key of type `ecdsa`` for the workspace with a time to live of 1000 blocks
fchain tx treasury new-key-request qredoworkspace14a2hpadpsy9h5m6us54 0 ecdsa 1000 --yes 

# wait for the MPC (keyring_id = 0) to pick up the request and generate a new key
# you can monitor all the requests with:
fchain q treasury key-requests 0 all

# and after the request in fulfilled you will find the public key along with addresses for supported wallet types in fusionchain:
fchain q treasury keys qredoworkspace14a2hpadpsy9h5m6us54

# let's use your new key to sign a payload
# payload must be a 32byte hash of arbitrary data to be singed
fchain tx treasury new-signature-request 1 '778f572f33acfab831365d52e563a0ddd2829ddd7060bec69719b7e41f6ef91c' 1000 --yes

# after a while you'll be able to retrieve the signature generated by the MPC
fchain q treasury signature-requests 0 all

### Broadcast

For the wallet address generated in the previous step, make sure it is funded. For this example, we are using `0xC828Bf9126667972400E1ABE600BAAB877B1e674` as an example. 

For the testnet Qredo runs its own watcher to broadcast the transaction. You can also run your own.

#### Pregenerated

This unsigned transaction only works for the first transaction to be sent from an address. The transaction looks as follows: 

```
nonce: 0
to: 0x993f45666B2A78434711D1a20D2A9733c07A5318
amount: 4000000000000000 WEI
gasLimit: 21000
gasPrice: 20000000000
data: 
```

Now request the transaction to be signed by the Fusion MPCs

```bash
# submit unsigned tx to be signed
fchain tx treasury new-sign-transaction-request 1 sepolia eb808504a817c80082520894993f45666b2a78434711d1a20d2a9733c07a5318870e35fa931a000080808080 1000 --yes

# check the tx signature request has been fulfilled
fchain query treasury sign-transaction-requests ethereum
```

#### More Tx

To create more transactions for that wallet, generate the unsigned tx by yourself:

```bash
# switch to the relayer-eth
cd relayer-eth

# create a unsinged transaction, adjust the nonce
go run ./cmd/buildtx/ -nonce 0 -to 0x993f45666B2A78434711D1a20D2A9733c07A5318 -amount 4000000000000000

# increase the nonce for each new transaction you want to submit
```

### Manage Workspaces

You can add and remove owners or adjust policies inside a workspace. 

```bash
# add a new owner to the workspace
fchain tx identity add-workspace-owner qredoworkspace14a2hpadpsy9h5m6us54 qredo1s3qj9p0ymugy6chyrwy3ft2s5u24fc320vdvv5 1000 --yes

# check the new owner has been added to the workspace
fchain q identity workspaces-by-owner qredo1s3qj9p0ymugy6chyrwy3ft2s5u24fc320vdvv5

# remove owner from the workspace
fchain tx identity remove-workspace-owner qredoworkspace14a2hpadpsy9h5m6us54 qredo1s3qj9p0ymugy6chyrwy3ft2s5u24fc320vdvv5 --yes

# check the new owner has been removed to the workspace
fchain q identity workspaces-by-owner qredo1s3qj9p0ymugy6chyrwy3ft2s5u24fc320vdvv5

# create a new workspace and append it to an existing one
fchain tx identity new-child-workspace qredoworkspace14a2hpadpsy9h5m6us54 1000 --yes

# check the indicated workspace has a new workspace as child_workspace
fchain q identity workspaces
```

### QAssets

As of now, QAssets are just in a demo state. Anyone can freely mint any QAsset they like. This will change once we are onboarding verifiable oracles. 

```bash
# Mint an ETH-QAssets to a workspace
fchain tx qassets mint qredoworkspace14a2hpadpsy9h5m6us54 sepolia false "" "" 1000000 --yes

# Check the workspace's balance
fchain q bank balances qredoworkspace14a2hpadpsy9h5m6us54

# Send QAssets
fchain tx qassets send qredoworkspace14a2hpadpsy9h5m6us54 qredoworkspace10j06zdk5gyl6vrss5d5 qETH-SEPOLIA 200000 --yes

# Check both the workspace's balance
fchain q bank balances qredoworkspace14a2hpadpsy9h5m6us54
fchain q bank balances qredoworkspace10j06zdk5gyl6vrss5d5

# Burn QAssets - This is also mocked right now
fchain tx qassets burn qredoworkspace14a2hpadpsy9h5m6us54 sepolia false "" "" 50000 --yes 

# Check both the workspace's balance
fchain q bank balances qredoworkspace14a2hpadpsy9h5m6us54
```
